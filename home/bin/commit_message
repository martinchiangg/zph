#!/usr/bin/env ruby

require 'open-uri'

DIVIDERS = %r{[-_/\\]}

PROVIDER, TASK_NAME, BASE_URL, WORKSPACE = ENV.values_at('COMMIT_MSG_PROVIDER',
                                                         'COMMIT_MSG_TASK_NAME',
                                                         'COMMIT_MSG_URL',
                                                         'COMMIT_MSG_WORKSPACE')

def run_specs
  require 'minitest/autorun'
  require 'minitest/pride'
  require 'stringio'

  describe "#main" do

    it 'compiles message when valid' do
      io = StringIO.new
      id = "24121042524524"
      main("#{id}/message_with_text_and_stuff", io)
      expected = <<-MSG
message with text and stuff

[#{PROVIDER} ##{id}](#{[BASE_URL, WORKSPACE, id].join("/")})
      MSG
      io.string.must_equal expected
    end
  end
end

def match_pattern(bn)
  bn.match(/(?<number>\d{6,})#{DIVIDERS}(?<description>.*)/)
end

def branch_name_from_git
  `git rev-parse --abbrev-ref HEAD`.chomp
end

def default_message
  ""
end

def main(branch_name, io = STDOUT)
  story = branch_name
  story = story.empty? ? "0" * 8 : story

  parts = match_pattern(branch_name)

  begin
    id = task_number = String(parts[:number])
    description = String(parts[:description]).gsub(/#{DIVIDERS}/, ' ')
  rescue
    io.print default_message
    exit(0)
  end

  commit_message = <<-MSG
#{description}

[#{PROVIDER} ##{id}](#{[BASE_URL, WORKSPACE, id].join("/")})
  MSG

  io << commit_message
end

if ARGV.first == "test"
  module Kernel
    def exit(*args)
    end
  end
  run_specs
else
  main(branch_name_from_git)
end
