#!/usr/bin/env ruby

def usage_and_exit
  usage = "git issue-patch [ISSUE_OR_PR_NUMBER]"
  warn usage
  exit(1)
end

usage_and_exit unless system("which gh > /dev/null")

GH = `which gh`.chomp

usage_and_exit if ARGV.empty?

remotes = `git remote -v`.chomp.split("\n").map { |l| l.split[1] }

usage_and_exit unless remotes.grep(/github/i)

full_name = remotes.first.split("github.com:")[1].gsub(/\.git$/i, '')

issue_no = ARGV.first

# If using as standalone
# url = "https://github.com/#{full_name}/pull/#{issue_no}.patch"
# patch = `curl --silent -L #{url}`.chomp
# require'pry';binding.pry
#
# If using as part of system
url = "https://github.com/#{full_name}/pull/#{issue_no}"
STDOUT.puts url

exec "#{GH} apply #{url} > /dev/null"
